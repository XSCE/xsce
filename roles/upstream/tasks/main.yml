- name: Make folder and set permission
  file: path={{ item }}
        owner=apache
        group=root
        mode=0755
        state=directory
  with_items:
    - "{{ content_base }}/upstream/html/raw_data"
    - "{{ content_base }}/upstream/html/zips"
    - "{{ content_base }}/upstream/history"
    - "{{ content_base }}/upstream/staging"
    - "{{ content_base }}/upstream/data"

- name: Put files where they belong
  template: src={{ item.src }}
            dest={{ item.dest }}
            owner=root
            group={{ item.group }}
            mode={{ item.mode }}
  with_items:
    - { src: 'upstream.conf', dest: '/etc/httpd/conf.d/', group: "root" , mode: '0644' }
    - { src: 'upstream.wsgi', dest: '{{ content_base }}/upstream', group: "root" , mode: '0644' }
    - { src: 'sift.py', dest: '{{ content_base }}/upstream', group: "apache" , mode: '0755' }
    - { src: 'harvest.py', dest: '{{ content_base }}/upstream', group: "apache" , mode: '0755' }
    - { src: 'mkchunk', dest: '{{ content_base }}/upstream', group: "apache" , mode: '0755' }
    - { src: 'acpower.service', dest: '/etc/systemd/system/', group: "root" , mode: '0644' }
    - { src: 'heartbeat', dest: '/usr/bin/', group: "root" , mode: '0755' }
    - { src: 'analyze-power', dest: '/usr/bin/', group: "root" , mode: '0755' }
    - { src: 'xsce-acpower-init', dest: '/usr/libexec/', group: "root" , mode: '0755' }
  when: upstream_install == True

- name: enable the downloading of data chunk
  template: src='upstream.conf'
            mode=0644
            dest=/etc/httpd/conf.d/
  when: upstream_enabled

- name: remove config file to disable
  file: path=/etc/httpd/conf.d/upstream.conf
        state=absent
  when: not upstream_enabled == True

- name: Start periodic logging of acpower
  service: name=acpower
           state=started
           enabled=yes
  when: acpower_enabled == True

- name: Stop periodic logging of acpower
  service: name=acpower
           state=stop
           enabled=no
  when: acpower_enabled != True

- name: add upstream to service list
  ini_file: dest='{{ service_filelist }}'
            section=upstream
            option='{{ item.option }}'
            value='{{ item.value }}'
  with_items:
    - option: name
      value: Upstream
    - option: description
      value: '"Upstream is a method of communicating usage information from the XSCE server to a centralized data collection location.  It uses a smart phone to download a zipped directory of information while offline, and then later, when connected to the internet, emails that package, as an attachment, upstream"'
    - option: enabled
      value: "{{ upstream_enabled }}"
    - option: installed
      value: "{{ upstream_install }}"
    - option: acpower_enabled
      value: "{{ acpower_enabled }}"
