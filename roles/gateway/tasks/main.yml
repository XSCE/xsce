- name: Create olpc-scripts directory
  file: path={{ item }}
        owner=root
        group=root
        mode=0755
        state=directory
  with_items:
    - /etc/sysconfig/olpc-scripts/
    - /etc/sysconfig/olpc-scripts/setup.d/installed/

- include: dhcpd.yml
  tags:
    - dhcpd
    - gateway

- include: named.yml
  tags:
    - named
    - gateway

- include: squid.yml
  tags:
    - squid
    - gateway

- include: wondershaper.yml
  tags:
    - wondershaper
    - gateway

- include: network.yml
  tags:
    - network-discover
    - gateway

- include: iptables.yml
  tags:
    - gateway

- name: Create gateway flag
  shell: echo 1 > /etc/sysconfig/olpc-scripts/setup.d/installed/gateway
         creates=/etc/sysconfig/olpc-scripts/setup.d/installed/gateway

- name: detect if NM is active if so restart
  shell: "systemctl is-active NetworkManager"
  register: NM_active
  ignore_errors: True
  changed_when: false

- include: NM.yml
  when: NM_active.stdout == "active"
