# dhcpd service is restarted with NM dispatcher.d script
- name: Stop dhcpd
  service: name={{ dns_service }}
           state=stopped
  when: not dhcpd_enabled

- name: Stop named service
  service: name={{ dns_service }}
           state=stopped
  when: not named_enabled

- name: Start named service
  service: name={{ dns_service }}
           state=started
  ignore_errors: True
  when: named_enabled

- name: put resolvconf.conf in place now that nameserver is in place
  lineinfile: line="name_servers=127.0.0.1"
              regexp="^#name_servers.*"
              dest=/etc/resolvconf.conf
  when: named_enabled and is_debian

- name: configure the resolvconf to use our domain
  lineinfile: line="search_domains={{ xsce_domain }}"
              dest=/etc/resolvconf.conf
              insertafter="^name_servers.*"
  when: named_enabled and is_debian

- name: Now tell resolvconf to regenerate the resolv.conf file
  command: /sbin/resolvconf -u
  when: named_enabled and is_debian

- name: Stop dansguardian
  service: name=dansguardian
           state=stopped
  when: not dansguardian_enabled

- name: Restart dansguardian
  service: name=dansguardian
           state=restarted
  when: dansguardian_enabled
  ignore_errors: true

- name: Stop squid service
  service: name={{ proxy }}
           state=stopped
  when: not squid_enabled

# Squid get re-loaded with dispatcher.d
- name: Restart squid service
  service: name={{ proxy }}
           state=started
  when: squid_enabled

- name: Restart wondershaper service
  service: name=wondershaper
            state=restarted
  when: wondershaper_enabled

- name: Restart avahi service
  service: name=avahi-daemon
           state=restarted

- name: Create gateway flag
  shell: echo 1 > /etc/sysconfig/olpc-scripts/setup.d/installed/gateway
         creates=/etc/sysconfig/olpc-scripts/setup.d/installed/gateway
  when: xsce_network_mode == "Gateway"

- name: Run iptables
  command: /usr/bin/xs-gen-iptables

