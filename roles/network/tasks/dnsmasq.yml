# Remove named package if installed (compatibility)
- name: Remove named packages
  yum: name={{ item }}
       state=absent
  with_items:
   - bind
   - bind-utils
  tags:
    - download

- name: Install dnsmasq package
  yum: name={{ item }}
       state=installed
  with_items:
   - dnsmasq
  tags:
    - download

- name: Enable dnsmasq.d config folder
  lineinfile: backup=yes
              dest=/etc/dnsmasq.conf
              regexp="^conf-dir=/etc/dnsmasq.d"
              line="conf-dir=/etc/dnsmasq.d"
              insertafter=EOF
              state=present

- name: Create config files
  template: src={{ item.src }}
            dest={{ item.dest }}
            owner={{ item.owner }}
            group={{ item.owner }}
            mode={{ item.mode }}
  with_items:
    - src: 'xsce-dnsmasq.j2'
      dest: '/etc/dnsmasq.d/xsce-nameserver.conf'
      owner: 'root'
      group: 'root'
      mode: '0640'
    - src: 'xsce-dnsmasq_safesearch.j2'
      dest: '/etc/dnsmasq.d/xsce-google_safesearch.conf'
      owner: 'root'
      group: 'root'
      mode: '0640'
   
- name: Enable dnsmasq service
  service: name=dnsmasq
           enabled=yes
           state=restarted
