---
- name: Install moodle required packages
  yum: name={{ item }}
       state=present
  with_items:
    - python-psycopg2
  tags:
    - download

- name: Download the latest moodle repo
  git: repo={{ moodle_repo_url }}
       dest={{ xsce_base }}/moodle-{{ moodle_version }}
       depth=1
       version="MOODLE_{{ moodle_version }}_STABLE"
#  ignore_errors: yes
  when: not {{ use_cache }} and not {{ no_network }}
  tags:
    - download2

- name: Give apache permission to write moodle directory
  file: path={{ xsce_base }}
        group=apache
        mode=0775
        state=directory

- name: Remove stock moodle conf
  file: path='/etc/httpd/conf.d/moodle.conf'
        state=absent

- name: Configure moodle
  template: backup=yes
            src={{ item.src }}
            dest={{ item.dest }}
            owner=root
            group=root
            mode={{ item.mode }}
  with_items:
    - src: 'config.php.j2'
      dest: '{{ xsce_base }}/moodle-{{ moodle_version }}'
      mode: '0644'

- name: Enable moodle-current
  template: backup=yes
            src=022-moodle-current.j2
            dest=/etc/httpd/conf.d/022-moodle-current.conf
            owner=root
            group=root
            mode=0644
  when: moodle_current_enabled

- name: Disable moodle-current
  file: path=/etc/httpd/conf.d/022-moodle-current.conf
        state=absent
  when: not moodle_current_enabled

- name: Stop postgresql
  service: name=postgresql
           state=stopped

- name: Start postgresql-xs
  service: name=postgresql-xs
           state=started

- name: Create db user
  postgresql_user: name=moodle
                   password=moodle
                   role_attr_flags=NOSUPERUSER,NOCREATEROLE,NOCREATEDB
                   state=present
  sudo: yes
  sudo_user: postgres

- name: Create database
  postgresql_db: name=moodle-{{ moodle_version }}
                 encoding=utf8
                 owner=moodle
                 template=template0
                 state=present
  sudo: yes
  sudo_user: postgres

- name: Execute moodle startup script
#  command: /usr/libexec/moodle-xs-init start
  shell: php {{ xsce_base }}/moodle-{{ moodle_version }}/install.php

- name: Restart postgresql-xs
  service: name=postgresql-xs
           state=restarted

- name: Restart httpd
  service: name=httpd
           state=restarted

- name: add moodle to service list
  ini_file: dest='{{ service_filelist }}'
            section=moodle
            option='{{ item.option }}'
            value='{{ item.value }}'
  with_items:
    - option: name
      value: Moodle-current
    - option: description
      value: '"Access the current Moodle learning management system."'
    - option: path
      value: /moodle-current
    - option: moodle-current-enabled
      value: "{{ moodle_curent_enabled }}"
